/**
 * @file font_5x7.c
 * @brief Standard 5x7 Font Implementation.
 *
 * @author Architected by momentics <momentics@gmail.com>
 * @copyright (c) 2026 momentics
 */

#include "measlib/ui/fonts.h"
#include <stddef.h>

/**
 * @def FONT_START_CHAR
 * @brief The first ASCII character available in the font.
 */
#define FONT_START_CHAR 0x16

/**
 * @def FONT_HEIGHT
 * @brief The height of each character in pixels.
 */
#define FONT_HEIGHT 7

/**
 * @def FONT_STR_HEIGHT
 * @brief The vertical stride when rendering multiple lines of text.
 */
#define FONT_STR_HEIGHT 8

/**
 * @def FONT_WIDTH_MASK
 * @brief Mask to extract width information from the header byte.
 */
#define FONT_WIDTH_MASK 0x07

/**
 * @brief Helper macro for width encoding.
 *
 * The width is encoded such that `Encoded = 8 - Width`.
 * This maintains compatibility with the reference implementation.
 * @param w Character width in pixels.
 */
#define CW(w) (8 - (w))

/**
 * @brief Font Bitmap Data (5x7 pixels).
 *
 * Storage Format: `uint8_t` array.
 * - Each character consists of 7 bytes of column data.
 * - The first byte of each character block contains encoded width information.
 * - Format is column-major: Each byte represents a vertical column of pixels.
 */
static const uint8_t x5x7_bits[] = {
    // Char 0x16 (SYNC) width = 8
    0b00000000 | CW(8), // Header/Width byte
    0b00000110,         // |     ** |
    0b00000110,         // |     ** |
    0b01000110,         // | *   ** |
    0b11111110,         // |******* |
    0b11111110,         // |******* |
    0b01000000,         // | *      |

    // Char "\029" (Delta) width = 6
    0b00000000 | CW(6),
    0b00100000,
    0b00100000,
    0b01010000,
    0b01010000,
    0b10001000,
    0b11111000,

    // Char "\030" (Left Arrow) width = 4
    0b10000000 | CW(4),
    0b11000000,
    0b11100000,
    0b11110000,
    0b11100000,
    0b11000000,
    0b10000000,

    // Char "\031" (Inf) width = 8
    0b00000000 | CW(8),
    0b01101100,
    0b10110010,
    0b10010010,
    0b10011010,
    0b01101100,
    0b00000000,

    // Char "\032" width = 6
    0b00000000 | CW(6),
    0b00100000,
    0b01000000,
    0b11111000,
    0b01000000,
    0b00100000,
    0b00000000,

    // Char "\033" width = 6
    0b00000000 | CW(6),
    0b00100000,
    0b00010000,
    0b11111000,
    0b00010000,
    0b00100000,
    0b00000000,

    // Char "\034" (Pi) width = 6
    0b00000000 | CW(6),
    0b11111000,
    0b01010000,
    0b01010000,
    0b01010000,
    0b01010000,
    0b10011000,

    // Char "\035" (Micro) width = 6
    0b00000000 | CW(6),
    0b00000000,
    0b10001000,
    0b10001000,
    0b11011000,
    0b10101000,
    0b10000000,

    // Char "\036" (Ohm) width = 6
    0b01110000 | CW(6),
    0b10001000,
    0b10001000,
    0b10001000,
    0b01010000,
    0b01010000,
    0b11011000,

    // Char "\037" (Degree) width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10010000,
    0b01100000,
    0b00000000,
    0b00000000,
    0b00000000,

    // Char ' ' width = 4
    0b00000000 | CW(4),
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,

    // Char '!' width = 3
    0b01000000 | CW(3),
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b00000000,
    0b01000000,

    // Char '"' width = 8
    0b01010000 | CW(8),
    0b01010000,
    0b01010000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,

    // Char '#' width = 6
    0b01010000 | CW(6),
    0b01010000,
    0b11111000,
    0b01010000,
    0b11111000,
    0b01010000,
    0b01010000,

    // Char '$' width = 6
    0b00100000 | CW(6),
    0b01111000,
    0b10100000,
    0b01110000,
    0b00101000,
    0b11110000,
    0b00100000,

    // Char '%' width = 6
    0b11000000 | CW(6),
    0b11001000,
    0b00010000,
    0b00100000,
    0b01000000,
    0b10011000,
    0b00011000,

    // Char '&' width = 6
    0b00000000 | CW(6),
    0b00100000,
    0b01010000,
    0b01100000,
    0b10101000,
    0b10010000,
    0b01101000,

    // Char ''' width = 4
    0b01100000 | CW(4),
    0b01000000,
    0b10000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,

    // Char '(' width = 4
    0b00100000 | CW(4),
    0b01000000,
    0b10000000,
    0b10000000,
    0b10000000,
    0b01000000,
    0b00100000,

    // Char ')' width = 4
    0b10000000 | CW(4),
    0b01000000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b01000000,
    0b10000000,

    // Char '*' width = 6
    0b00000000 | CW(6),
    0b00100000,
    0b10101000,
    0b01110000,
    0b10101000,
    0b00100000,
    0b00000000,

    // Char '+' width = 6
    0b00000000 | CW(6),
    0b00100000,
    0b00100000,
    0b11111000,
    0b00100000,
    0b00100000,
    0b00000000,

    // Char ',' width = 3
    0b00000000 | CW(3),
    0b00000000,
    0b00000000,
    0b00000000,
    0b11000000,
    0b01000000,
    0b10000000,

    // Char '-' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b00000000,
    0b11110000,
    0b00000000,
    0b00000000,
    0b00000000,

    // Char '.' width = 3
    0b00000000 | CW(3),
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b11000000,
    0b11000000,

    // Char '/' width = 4
    0b00100000 | CW(4),
    0b00100000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b10000000,
    0b10000000,

    // Char '0' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b01100000,

    // Char '1' width = 5
    0b00100000 | CW(5),
    0b01100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b01110000,

    // Char '2' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b00010000,
    0b00100000,
    0b01000000,
    0b10000000,
    0b11110000,

    // Char '3' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b00010000,
    0b01100000,
    0b00010000,
    0b10010000,
    0b01100000,

    // Char '4' width = 5
    0b10010000 | CW(5),
    0b10010000,
    0b10010000,
    0b10010000,
    0b11110000,
    0b00010000,
    0b00010000,

    // Char '5' width = 5
    0b11110000 | CW(5),
    0b10000000,
    0b11100000,
    0b00010000,
    0b00010000,
    0b10010000,
    0b01100000,

    // Char '6' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10000000,
    0b11100000,
    0b10010000,
    0b10010000,
    0b01100000,

    // Char '7' width = 5
    0b11110000 | CW(5),
    0b00010000,
    0b00100000,
    0b00100000,
    0b01000000,
    0b01000000,
    0b01000000,

    // Char '8' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10010000,
    0b01100000,
    0b10010000,
    0b10010000,
    0b01100000,

    // Char '9' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10010000,
    0b01110000,
    0b00010000,
    0b10010000,
    0b01100000,

    // Char ':' width = 4
    0b00000000 | CW(4),
    0b11000000,
    0b11000000,
    0b00000000,
    0b11000000,
    0b11000000,
    0b00000000,

    // Char ';' width = 4
    0b00000000 | CW(4),
    0b01100000,
    0b01100000,
    0b00000000,
    0b01100000,
    0b01000000,
    0b10000000,

    // Char '<' width = 5
    0b00000000 | CW(5),
    0b00100000,
    0b01000000,
    0b10000000,
    0b01000000,
    0b00100000,
    0b00000000,

    // Char '=' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b11110000,
    0b00000000,
    0b11110000,
    0b00000000,
    0b00000000,

    // Char '>' width = 5
    0b00000000 | CW(5),
    0b10000000,
    0b01000000,
    0b00100000,
    0b01000000,
    0b10000000,
    0b00000000,

    // Char '?' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b00010000,
    0b00100000,
    0b01000000,
    0b00000000,
    0b01000000,

    // Char '@' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10110000,
    0b10110000,
    0b10000000,
    0b10000000,
    0b01110000,

    // Char 'A' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10010000,
    0b10010000,
    0b11110000,
    0b10010000,
    0b10010000,

    // Char 'B' width = 5
    0b11100000 | CW(5),
    0b10010000,
    0b10010000,
    0b11100000,
    0b10010000,
    0b10010000,
    0b11100000,

    // Char 'C' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10000000,
    0b10000000,
    0b10000000,
    0b10010000,
    0b01100000,

    // Char 'D' width = 5
    0b11100000 | CW(5),
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b11100000,

    // Char 'E' width = 5
    0b11110000 | CW(5),
    0b10000000,
    0b10000000,
    0b11100000,
    0b10000000,
    0b10000000,
    0b11110000,

    // Char 'F' width = 5
    0b11110000 | CW(5),
    0b10000000,
    0b10000000,
    0b11100000,
    0b10000000,
    0b10000000,
    0b10000000,

    // Char 'G' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10000000,
    0b10110000,
    0b10010000,
    0b10010000,
    0b01110000,

    // Char 'H' width = 5
    0b10010000 | CW(5),
    0b10010000,
    0b10010000,
    0b11110000,
    0b10010000,
    0b10010000,
    0b10010000,

    // Char 'I' width = 4
    0b11100000 | CW(4),
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b11100000,

    // Char 'J' width = 5
    0b01110000 | CW(5),
    0b00010000,
    0b00010000,
    0b00010000,
    0b00010000,
    0b10010000,
    0b01100000,

    // Char 'K' width = 5
    0b10010000 | CW(5),
    0b10010000,
    0b10010000,
    0b11100000,
    0b10010000,
    0b10010000,
    0b10010000,

    // Char 'L' width = 5
    0b10000000 | CW(5),
    0b10000000,
    0b10000000,
    0b10000000,
    0b10000000,
    0b10000000,
    0b11110000,

    // Char 'M' width = 6
    0b10001000 | CW(6),
    0b11011000,
    0b10101000,
    0b10101000,
    0b10101000,
    0b10001000,
    0b10001000,

    // Char 'N' width = 5
    0b10010000 | CW(5),
    0b10010000,
    0b11010000,
    0b10110000,
    0b10010000,
    0b10010000,
    0b10010000,

    // Char 'O' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b01100000,

    // Char 'P' width = 5
    0b11100000 | CW(5),
    0b10010000,
    0b10010000,
    0b11100000,
    0b10000000,
    0b10000000,
    0b10000000,

    // Char 'Q' width = 5
    0b01100000 | CW(5),
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b10100000,
    0b01010000,

    // Char 'R' width = 5
    0b11100000 | CW(5),
    0b10010000,
    0b10010000,
    0b11100000,
    0b10100000,
    0b10010000,
    0b10010000,

    // Char 'S' width = 5
    0b01110000 | CW(5),
    0b10000000,
    0b11100000,
    0b00010000,
    0b10010000,
    0b01100000,
    0b00000000,

    // Char 'T' width = 5
    0b11111000 | CW(5),
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,

    // Char 'U' width = 5
    0b10010000 | CW(5),
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b01100000,

    // Char 'V' width = 5
    0b10001000 | CW(5),
    0b10001000,
    0b10001000,
    0b10001000,
    0b01010000,
    0b01010000,
    0b00100000,

    // Char 'W' width = 5
    0b10001000 | CW(5),
    0b10001000,
    0b10001000,
    0b10101000,
    0b10101000,
    0b10101000,
    0b01010000,

    // Char 'X' width = 5
    0b10001000 | CW(5),
    0b10001000,
    0b01010000,
    0b00100000,
    0b01010000,
    0b10001000,
    0b10001000,

    // Char 'Y' width = 5
    0b10001000 | CW(5),
    0b10001000,
    0b01010000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,

    // Char 'Z' width = 5
    0b11111000 | CW(5),
    0b00001000,
    0b00010000,
    0b00100000,
    0b01000000,
    0b10000000,
    0b11111000,

    // Char '[' width = 4
    0b00111000 | CW(4),
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00111000,

    // Char '\' width = 4
    0b10000000 | CW(4),
    0b10000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b00100000,
    0b00100000,

    // Char ']' width = 4
    0b11100000 | CW(4),
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b11100000,

    // Char '^' width = 5
    0b00100000 | CW(5),
    0b01010000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,

    // Char '_' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b11111000,

    // Char '`' width = 4
    0b10000000 | CW(4),
    0b01000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,

    // Char 'a' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b01110000,
    0b10001000,
    0b10001000,
    0b10001000,
    0b01111000,

    // Char 'b' width = 5
    0b10000000 | CW(5),
    0b10000000,
    0b10110000,
    0b11001000,
    0b10001000,
    0b10001000,
    0b11110000,

    // Char 'c' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b01110000,
    0b10000000,
    0b10000000,
    0b10000000,
    0b01110000,

    // Char 'd' width = 5
    0b00001000 | CW(5),
    0b00001000,
    0b01101000,
    0b10011000,
    0b10001000,
    0b10001000,
    0b01111000,

    // Char 'e' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b01100000,
    0b10010000,
    0b11110000,
    0b10000000,
    0b01110000,

    // Char 'f' width = 4
    0b00110000 | CW(4),
    0b01000000,
    0b11100000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,

    // Char 'g' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b01111000,
    0b10001000,
    0b10001000,
    0b01111000,
    0b00001000,
    // 0b01110000, // Descender handled? Standard 5x7 height is fixed. Logic
    // might need adjust for descenders.
    // Keeping data AS IS from reference, but noting height limit of 7.
    // Reference defines FONT_GET_HEIGHT as 7.

    // Char 'h' width = 5
    0b10000000 | CW(5),
    0b10000000,
    0b10110000,
    0b11001000,
    0b10001000,
    0b10001000,
    0b10001000,

    // Char 'i' width = 3
    0b00100000 | CW(3),
    0b00000000,
    0b01100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b01110000,

    // Char 'j' width = 4
    0b00010000 | CW(4),
    0b00000000,
    0b00110000,
    0b00010000,
    0b00010000,
    0b00010000,
    0b10010000,

    // Char 'k' width = 5
    0b10000000 | CW(5),
    0b10000000,
    0b10010000,
    0b10100000,
    0b11100000,
    0b10100000,
    0b10010000,

    // Char 'l' width = 3
    0b01100000 | CW(3),
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b01110000,

    // Char 'm' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b11010000,
    0b10101000,
    0b10101000,
    0b10101000,
    0b10101000,

    // Char 'n' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b11100000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,

    // Char 'o' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b01100000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b01100000,

    // Char 'p' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b11110000,
    0b10010000,
    0b10010000,
    0b11110000,
    0b10000000,

    // Char 'q' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b01111000,
    0b10001000,
    0b10001000,
    0b01111000,
    0b00001000,

    // Char 'r' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b10110000,
    0b11000000,
    0b10000000,
    0b10000000,
    0b10000000,

    // Char 's' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b01110000,
    0b10000000,
    0b01110000,
    0b00010000,
    0b11100000,

    // Char 't' width = 4
    0b01000000 | CW(4),
    0b01000000,
    0b11100000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b00110000,

    // Char 'u' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b10010000,
    0b01110000,

    // Char 'v' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b10001000,
    0b10001000,
    0b01010000,
    0b00100000,
    0b00100000,

    // Char 'w' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b10001000,
    0b10001000,
    0b10101000,
    0b10101000,
    0b01010000,

    // Char 'x' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b10001000,
    0b01010000,
    0b00100000,
    0b01010000,
    0b10001000,

    // Char 'y' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b10001000,
    0b10001000,
    0b10001000,
    0b01111000,
    0b00001000,

    // Char 'z' width = 5
    0b00000000 | CW(5),
    0b00000000,
    0b11110000,
    0b00010000,
    0b00100000,
    0b01000000,
    0b11110000,

    // Char '{' width = 4
    0b00011000 | CW(4),
    0b00100000,
    0b00100000,
    0b01000000,
    0b00100000,
    0b00100000,
    0b00011000,

    // Char '|' width = 3
    0b00100000 | CW(3),
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00100000,

    // Char '}' width = 4
    0b11000000 | CW(4),
    0b01000000,
    0b01000000,
    0b00100000,
    0b01000000,
    0b01000000,
    0b11000000,

    // Char '~' width = 5
    0b00000000 | CW(5),
    0b01000000,
    0b10100000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
};

static const uint8_t *font_5x7_get_glyph(const uint8_t *font_data, char c,
                                         uint8_t *w_out, uint8_t *h_out) {
  uint8_t index = (uint8_t)c;
  if (index < FONT_START_CHAR || index > 126)
    index = ' '; // Fallback

  const uint8_t *glyph = &font_data[(index - FONT_START_CHAR) * FONT_HEIGHT];

  // Decoded width from first byte
  // Original logic: (8 - (byte & 7))
  if (w_out)
    *w_out = 8 - (glyph[0] & FONT_WIDTH_MASK);

  if (h_out)
    *h_out = FONT_HEIGHT;

  return glyph;
}

const meas_font_t font_5x7 = {
    .bitmap = x5x7_bits,
    .width_max = 5,
    .height = FONT_HEIGHT,
    .start_char = FONT_START_CHAR,
    .end_char = 126,
    .get_glyph = font_5x7_get_glyph,
};
